# PLOScope Full Stack Orchestration
# =================================
#
# This compose file brings up the entire PLOScope poker analysis platform.
#
# IMPORTANT: Images are expected from GitHub Container Registry (ghcr.io/ploscope/*)
# If these don't exist, use docker-compose.dev.yml to build from source.
#
# Usage:
#   docker compose up -d                              # Start all services
#   docker compose --profile monitoring up -d         # Include monitoring stack
#   docker compose --profile dev up -d                # Include dev tools
#   docker compose down                               # Stop all services
#
# Prerequisites:
#   - Copy .env.example to .env and configure
#   - Run ./scripts/setup.sh for guided setup

x-common-labels: &common-labels
  com.ploscope.project: "ploscope"
  com.ploscope.managed-by: "ploscope-stack"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ============================================
  # INFRASTRUCTURE - Core Dependencies
  # These must start first and stay healthy
  # ============================================

  traefik:
    image: traefik:v3.2
    container_name: ploscope-traefik
    labels:
      <<: *common-labels
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=plo-network-cloud
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.traefik.address=:8080
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --accesslog=true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/etc/certs
      - traefik-logs:/var/log/traefik
    environment:
      - TRAEFIK_DOMAIN=${TRAEFIK_DOMAIN:-localhost}
      - ACME_EMAIL=${ACME_EMAIL:-}
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.10
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      <<: *healthcheck-defaults
      start_period: 10s
    logging: *default-logging
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    container_name: ploscope-db
    labels:
      <<: *common-labels
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-backups:/backups
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-plosolver}
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.14
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-plosolver}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging: *default-logging
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ploscope-redis
    labels:
      <<: *common-labels
    command: redis-server --requirepass ${REDIS_PASSWORD:-dev_redis_password_2024}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-dev_redis_password_2024}
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.15
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-dev_redis_password_2024}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    logging: *default-logging
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: ploscope-rabbitmq
    labels:
      <<: *common-labels
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USERNAME:-plosolver}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-dev_password_2024}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST:-/plosolver}
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.11
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    restart: unless-stopped

  # ============================================
  # INIT SERVICES - Run once at startup
  # These set up the database and message queues
  # ============================================

  rabbitmq-init:
    image: ghcr.io/ploscope/rabbitmq-init:${RABBITMQ_INIT_TAG:-latest}
    container_name: ploscope-rabbitmq-init
    labels:
      <<: *common-labels
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-plosolver}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-dev_password_2024}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-/plosolver}
      - RABBITMQ_SPOT_QUEUE=${RABBITMQ_SPOT_QUEUE:-spot-processing}
      - RABBITMQ_SOLVER_QUEUE=${RABBITMQ_SOLVER_QUEUE:-solver-processing}
      - RABBITMQ_SPOT_DLQ=${RABBITMQ_SPOT_DLQ:-spot-processing-dlq}
      - RABBITMQ_SOLVER_DLQ=${RABBITMQ_SOLVER_DLQ:-solver-processing-dlq}
      - RABBITMQ_MAIN_EXCHANGE=${RABBITMQ_MAIN_EXCHANGE:-plosolver.main}
      - RABBITMQ_DLQ_EXCHANGE=${RABBITMQ_DLQ_EXCHANGE:-plosolver.dlq}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - plo-network-cloud
    restart: "no"

  db-init:
    image: ghcr.io/ploscope/db-init:${DB_INIT_TAG:-latest}
    container_name: ploscope-db-init
    labels:
      <<: *common-labels
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-plosolver}
      - POSTGRES_DB=${POSTGRES_DB:-plosolver}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_HOST=db
      - PGPASSWORD=${POSTGRES_PASSWORD:-postgres}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - plo-network-cloud
    restart: "no"

  # ============================================
  # CORE SERVICES - The Application
  # ============================================

  backend:
    image: ghcr.io/ploscope/backend:${BACKEND_TAG:-latest}
    container_name: ploscope-backend
    labels:
      <<: *common-labels
      traefik.enable: "true"
      traefik.http.routers.backend.rule: "PathPrefix(`/api`)"
      traefik.http.routers.backend.entrypoints: "web"
      traefik.http.services.backend.loadbalancer.server.port: "5001"
    ports:
      - "5001:5001"
    volumes:
      - shared-logs:/app/logs
      - uploads:/app/uploads
    environment:
      # Flask
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - FLASK_ENV=${FLASK_ENV:-production}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-plosolver}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-plosolver}
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      # Message Queue
      - QUEUE_PROVIDER=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-plosolver}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-dev_password_2024}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-/plosolver}
      # Cache
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-dev_redis_password_2024}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-dev_redis_password_2024}@redis:6379/0
      # Security
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-me-in-production}
      # OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      # CORS
      - WEBSOCKET_CORS_ORIGINS=${WEBSOCKET_CORS_ORIGINS:-http://localhost:3000,https://ploscope.com}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      rabbitmq-init:
        condition: service_completed_successfully
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.20
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5001/api/health || exit 1"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped

  backend-grpc:
    image: ghcr.io/ploscope/backend:${BACKEND_TAG:-latest}
    container_name: ploscope-backend-grpc
    labels:
      <<: *common-labels
    command: ["python", "-m", "src.backend.grpc_main"]
    ports:
      - "50051:50051"
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-plosolver}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-plosolver}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-dev_password_2024}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-/plosolver}
      - HOST=0.0.0.0
      - GRPC_PORT=50051
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.21
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50051 || exit 1"]
      <<: *healthcheck-defaults
      start_period: 20s
    logging: *default-logging
    restart: unless-stopped

  frontend:
    image: ghcr.io/ploscope/frontend:${FRONTEND_TAG:-latest}
    container_name: ploscope-frontend
    labels:
      <<: *common-labels
      traefik.enable: "true"
      traefik.http.routers.frontend.rule: "PathPrefix(`/`)"
      traefik.http.routers.frontend.entrypoints: "web"
      traefik.http.routers.frontend.priority: "1"
      traefik.http.services.frontend.loadbalancer.server.port: "3000"
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - REACT_APP_API_URL=${REACT_APP_API_URL:-/api}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.12
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped

  # ============================================
  # WORKERS - Background Processing
  # ============================================

  celery-worker:
    image: ghcr.io/ploscope/celery-worker:${CELERY_WORKER_TAG:-latest}
    container_name: ploscope-celery-worker
    labels:
      <<: *common-labels
    volumes:
      - shared-logs:/app/logs
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-plosolver}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-plosolver}
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-plosolver}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-dev_password_2024}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-/plosolver}
      - RABBITMQ_SPOT_QUEUE=${RABBITMQ_SPOT_QUEUE:-spot-processing}
      - RABBITMQ_SOLVER_QUEUE=${RABBITMQ_SOLVER_QUEUE:-solver-processing}
      - CELERY_BROKER_URL=amqp://${RABBITMQ_USERNAME:-plosolver}:${RABBITMQ_PASSWORD:-dev_password_2024}@rabbitmq:5672/%2Fplosolver
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-dev_redis_password_2024}@redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-dev_redis_password_2024}
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY:-4}
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      rabbitmq-init:
        condition: service_completed_successfully
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.22
    healthcheck:
      test: ["CMD-SHELL", "celery -A src.celery_worker.main inspect ping -d celery@$$HOSTNAME || exit 1"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    restart: unless-stopped

  # ============================================
  # MONITORING - Observability Stack (Optional)
  # Enable with: --profile monitoring
  # ============================================

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: ploscope-prometheus
    labels:
      <<: *common-labels
    profiles:
      - monitoring
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_DAYS:-7}d'
      - '--web.enable-lifecycle'
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.30
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      <<: *healthcheck-defaults
      start_period: 10s
    logging: *default-logging
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.2
    container_name: ploscope-grafana
    labels:
      <<: *common-labels
    profiles:
      - monitoring
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_SERVER_HTTP_PORT=3000
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN:-grafana.localhost}
      - GF_LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.31
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_healthy

  loki:
    image: grafana/loki:2.9.2
    container_name: ploscope-loki
    labels:
      <<: *common-labels
    profiles:
      - monitoring
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
      - ./config/loki/loki-config.yml:/etc/loki/config.yaml:ro
    command: -config.file=/etc/loki/config.yaml
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.32
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/ready"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G

  # ============================================
  # DEV TOOLS (Optional)
  # Enable with: --profile dev
  # ============================================

  portainer:
    image: portainer/portainer-ce:2.19.4-alpine
    container_name: ploscope-portainer
    labels:
      <<: *common-labels
    profiles:
      - dev
    command: -H unix:///var/run/docker.sock
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - plo-network-cloud
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/api/system/status"]
      <<: *healthcheck-defaults
      start_period: 60s
    logging: *default-logging
    restart: unless-stopped

# ============================================
# VOLUMES
# ============================================

volumes:
  # Infrastructure
  traefik-certs:
  traefik-logs:
  redis-data:
  rabbitmq-data:
  postgres-data:
  postgres-backups:
  
  # Application
  shared-logs:
  uploads:
  
  # Monitoring
  prometheus-data:
  grafana-data:
  loki-data:
  
  # Dev Tools
  portainer-data:

# ============================================
# NETWORKS
# ============================================

networks:
  plo-network-cloud:
    driver: bridge
    name: plo-network-cloud
    ipam:
      config:
        - subnet: 172.30.1.0/24
