# PLOScope Deployment Guide

## Deployment Options

### 1. Single Server (Docker Compose)

Best for: Small deployments, staging environments

### 2. Docker Swarm

Best for: High availability, horizontal scaling

### 3. Kubernetes

Best for: Large scale, enterprise deployments (future)

---

## Single Server Deployment

### Requirements

- Ubuntu 22.04 LTS (recommended)
- 4+ CPU cores
- 8+ GB RAM
- 50+ GB SSD storage
- Domain pointing to server IP

### Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# Install Docker Compose plugin
sudo apt install docker-compose-plugin

# Logout and login to apply group changes
```

### Deploy Stack

```bash
# Clone repository
git clone https://github.com/PLOScope/ploscope-stack.git
cd ploscope-stack

# Run setup (select production mode)
./scripts/setup.sh

# Configure production settings
nano .env
```

### Production Environment Variables

```bash
# .env for production
ENVIRONMENT=production
DOMAIN=ploscope.com

# Strong passwords (auto-generated by setup)
POSTGRES_PASSWORD=<strong-password>
RABBITMQ_PASSWORD=<strong-password>
REDIS_PASSWORD=<strong-password>
SECRET_KEY=<strong-secret>
JWT_SECRET_KEY=<strong-secret>

# SSL
ACME_EMAIL=admin@ploscope.com
TRAEFIK_HTTPS_ENABLED=true

# Logging
LOG_LEVEL=WARNING
```

### Start Production Stack

```bash
# Pull latest images
docker compose pull

# Start with production overrides
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Or use make
make prod
```

### Verify Deployment

```bash
# Check all services are healthy
docker compose ps

# Test endpoints
curl -I https://ploscope.com
curl https://ploscope.com/api/health
```

---

## SSL/TLS Configuration

### Automatic (Let's Encrypt)

The production compose file automatically obtains SSL certificates:

```yaml
# In docker-compose.prod.yml
traefik:
  command:
    - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
    - --certificatesresolvers.letsencrypt.acme.storage=/etc/certs/acme.json
    - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
```

### Manual Certificates

If using your own certificates:

```bash
# Create certs volume
docker volume create traefik-certs

# Copy certificates
docker run --rm -v traefik-certs:/certs -v $(pwd):/source alpine \
  cp /source/fullchain.pem /source/privkey.pem /certs/

# Update Traefik config to use file provider
```

---

## Database Management

### Backups

```bash
# Manual backup
make db-backup

# Automated backup (add to cron)
0 2 * * * cd /path/to/ploscope-stack && make db-backup
```

### Restore

```bash
# Stop backend services
docker compose stop backend celery-worker

# Restore from backup
docker compose exec -T db psql -U postgres -d plosolver < backup.sql

# Restart services
docker compose start backend celery-worker
```

### Migrations

```bash
# Run migrations
docker compose run --rm db-init

# Or if using external db-init image
docker compose up db-init
```

---

## Monitoring

### Enable Monitoring Stack

```bash
# Start with monitoring profile
docker compose --profile monitoring up -d

# Or in production
docker compose -f docker-compose.yml -f docker-compose.prod.yml --profile monitoring up -d
```

### Grafana Setup

1. Access Grafana at https://grafana.ploscope.com
2. Login with admin / (password from .env)
3. Datasources are pre-configured
4. Import dashboards from `config/grafana/dashboards/`

### Alerts

Configure alerts in Grafana or Prometheus:

```yaml
# Example Prometheus alert rule
groups:
  - name: ploscope
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
```

---

## Scaling

### Horizontal Scaling (Backend)

```bash
# Scale backend to 3 instances
docker compose up -d --scale backend=3
```

### Horizontal Scaling (Workers)

```bash
# Scale workers to 5 instances
docker compose up -d --scale celery-worker=5
```

### Load Balancing

Traefik automatically load balances between scaled instances.

---

## Updates

### Zero-Downtime Updates

```bash
# Pull new images
docker compose pull

# Recreate services one at a time
docker compose up -d --no-deps backend
docker compose up -d --no-deps frontend
docker compose up -d --no-deps celery-worker
```

### Database Migrations

```bash
# Run migrations before updating backend
docker compose run --rm db-init

# Then update backend
docker compose up -d backend
```

### Rollback

```bash
# Specify previous image tag
BACKEND_TAG=v1.2.3 docker compose up -d backend
```

---

## Security Hardening

### Firewall Rules

```bash
# UFW example
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw enable
```

### Disable Unnecessary Ports

In production, don't expose database ports:

```yaml
# Override in docker-compose.prod.yml
db:
  ports: []  # No external port
```

### Regular Updates

```bash
# Update base images monthly
docker compose pull
docker compose up -d
```

---

## Troubleshooting

### Service Won't Start

```bash
# Check logs
docker compose logs <service>

# Check resources
docker stats

# Check disk space
df -h
```

### SSL Certificate Issues

```bash
# Check certificate status
docker compose exec traefik cat /etc/certs/acme.json | jq

# Force certificate renewal
docker compose restart traefik
```

### High Memory Usage

```bash
# Check per-container usage
docker stats --no-stream

# Adjust limits in docker-compose.prod.yml
deploy:
  resources:
    limits:
      memory: 1G
```

### Connection Refused

```bash
# Verify service is running
docker compose ps

# Check health status
docker inspect <container> | jq '.[0].State.Health'

# Check network
docker network inspect plo-network-cloud
```

---

## Maintenance Windows

### Planned Maintenance

```bash
# Enable maintenance mode (serve static page)
docker compose exec traefik touch /maintenance

# Perform maintenance
# ...

# Disable maintenance mode
docker compose exec traefik rm /maintenance
```

### Emergency Procedures

```bash
# Stop all services immediately
docker compose down

# Start essential services only
docker compose up -d db redis rabbitmq traefik

# Gradually bring up application
docker compose up -d backend
docker compose up -d frontend
docker compose up -d celery-worker
```
