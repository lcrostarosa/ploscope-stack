---
# It is triggered by a push to the master branch.
# It is also triggered by a workflow_dispatch event.
# The workflow will create a new tag and release the RabbitMQ and database services to Docker Hub.
# The workflow will also create a new release on the GitHub repository.
name: Release RabbitMQ and Database Services

on:
  push:
    branches: [master]
    paths:
      - '**'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        default: false
        type: boolean

jobs:
  tag_build_release:
    runs-on: ${{ vars.GHA_RUNNER }}
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install poetry manually (fallback for self-hosted runners)
        if: ${{ vars.GHA_RUNNER }} == 'self-hosted'
        env:
          POETRY_HTTP_BASIC_NEXUS_INTERNAL_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          POETRY_HTTP_BASIC_NEXUS_INTERNAL_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          curl -sL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - uses: actions/cache@v3
        name: Define a cache for the virtual environment based on the dependencies lock file
        if: github.event.inputs.skip_tests != 'true' || github.event.inputs.publish_pypi == 'true' || github.event_name == 'push' || github.event_name == 'pull_request'
        with:
          path: ./.venv
          key: venv-${{ hashFiles('poetry.lock') }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set RabbitMQ init image tags
        id: rabbitmq-meta
        uses: docker/metadata-action@v5
        with:
          images: docker.io/ploscope/rabbitmq-init
          tags: |
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/master' }}
            type=raw,value=master,enable=${{ github.ref == 'refs/heads/master' }}
            type=raw,value=production,enable=${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/') }}
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push RabbitMQ init image (AMD64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: './Dockerfile'
          push: true
          platforms: linux/amd64
          tags: ${{ steps.rabbitmq-meta.outputs.tags }}
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Create release
        id: release
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            current_version=$(poetry version -s)
            release_type="${{ github.event.inputs.release_type }}"
            case "$release_type" in
              "major") poetry version major ;;
              "minor") poetry version minor ;;
              "patch") poetry version patch ;;
            esac
            new_version=$(poetry version -s)
            tag="v$new_version"
            git add pyproject.toml
            git commit -m "chore: bump version to $new_version [skip ci]"
            git tag -a $tag -m "Release $tag"
            git push origin $tag
            git push origin HEAD
            gh release create $tag --title "Release RabbitMQ and Database Services $tag" --notes "## RabbitMQ and Database Services Release $tag\n\nThis release includes:\n- RabbitMQ queue initialization service\n- Database migration service\n- Integrated testing and deployment workflows\n- Updated Docker images for both services\n\n### Docker Images\n- \`ploscope/rabbitmq-init:$tag\` - RabbitMQ queue initialization\n- \`ploscope/db-migrate:$tag\` - Database migration service\n\n### Changes\n- Integrated RabbitMQ and database services\n- Enhanced CI/CD pipeline\n- Improved testing and validation\n- Updated documentation" ${{ github.event.inputs.prerelease == 'true' && '--prerelease' || '' }}
          else
            current_version=$(poetry version -s)
            poetry version patch
            new_version=$(poetry version -s)
            tag="v$new_version"
            git add pyproject.toml
            git commit -m "chore: bump version to $new_version [skip ci]"
            git tag -a $tag -m "Release $tag"
            git push origin $tag
            git push origin HEAD
            gh release create $tag --title "Release RabbitMQ and Database Services $tag" --notes "## RabbitMQ and Database Services Release $tag\n\nThis release includes:\n- RabbitMQ queue initialization service\n- Database migration service\n- Integrated testing and deployment workflows\n- Updated Docker images for both services\n\n### Docker Images\n- \`ploscope/rabbitmq-init:$tag\` - RabbitMQ queue initialization\n- \`ploscope/db-migrate:$tag\` - Database migration service\n\n### Changes\n- Integrated RabbitMQ and database services\n- Enhanced CI/CD pipeline\n- Improved testing and validation\n- Updated documentation"
          fi
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "version=$new_version" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
          GH_TOKEN: ${{ secrets.PAT }}

      - name: Notify deployment
        run: |
          echo "ðŸŽ‰ Release ${{ steps.release.outputs.tag }} created successfully!"
          echo "ðŸ“¦ Docker images published:"
          echo "   - ploscope/rabbitmq-init:${{ steps.release.outputs.version }}"
          echo "   - ploscope/db-migrate:${{ steps.release.outputs.version }}"
          echo "ðŸ“‹ GitHub release: ${{ steps.release.outputs.tag }}"
          echo "ðŸš€ Ready for deployment to staging/production"
