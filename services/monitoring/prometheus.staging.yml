global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          environment: 'staging'

  - job_name: 'traefik'
    static_configs:
      - targets: ['traefik:8082']
        labels:
          environment: 'staging'
    metrics_path: /metrics
    scrape_interval: 10s

  - job_name: 'alloy'
    static_configs:
      - targets: ['alloy:12345']
        labels:
          environment: 'staging'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'frontend'
    static_configs:
      - targets: ['frontend:3000']
        labels:
          environment: 'staging'
          service: 'frontend'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'backend'
    static_configs:
      - targets: ['backend:8000']
        labels:
          environment: 'staging'
          service: 'backend'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'celeryworker'
    static_configs:
      - targets: ['celeryworker:8001']
        labels:
          environment: 'staging'
          service: 'celeryworker'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'db'
    static_configs:
      - targets: ['db:5432']
        labels:
          environment: 'staging'
          service: 'database'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['rabbitmq:15692']
        labels:
          environment: 'staging'
          service: 'rabbitmq'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'nexus'
    static_configs:
      - targets: ['nexus:8081']
        labels:
          environment: 'staging'
          service: 'nexus'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s

  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          environment: 'staging'
          service: 'cadvisor'
    metrics_path: /metrics
    scrape_interval: 15s
    scrape_timeout: 10s
    metric_relabel_configs:
      # Extract container name from the id label
      - source_labels: [id]
        regex: '/docker/([a-z0-9]{64})'
        target_label: container_id_short
        replacement: '${1}'
      # Shorten the ID to first 12 characters
      - source_labels: [container_id_short]
        regex: '([a-z0-9]{12}).*'
        target_label: container_short_id
        replacement: '${1}'

  # Federation from production
  - job_name: 'federate-production'
    scrape_interval: 30s
    honor_labels: true
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job=~".+"}'
    static_configs:
      - targets: ['prometheus-prod.ploscope.com']
    basic_auth:
      username: prometheususer
      password: securepassword123
    scheme: https
