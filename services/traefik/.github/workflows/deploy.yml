name: Deploy traefik Repository

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: staging
        type: string
      branch:
        description: 'Branch to deploy'
        required: true
        default: master
        type: string

env:
  REGISTRY: docker.io
  NAMESPACE: ploscope
  IMAGE_NAME: traefik

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  deploy:
    timeout-minutes: 1
    name: Deploy traefik
    runs-on: ${{ vars.GHA_RUNNER }}
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
           
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
    
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3

        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          allenvs: true
          script: |
            set -e
            echo "üöÄ Deploying traefik..."
            
            # Set environment variables directly in the SSH session
            export APP_PATH=~/ploscope/traefik
            export ENVIRONMENT=${{ inputs.environment }}
            export CONTAINER_NAME=traefik-${{ inputs.environment }}
            export NETWORK_NAME=plo-network-cloud
            export ACME_VOLUME=acme:/etc/certs
            export TRAEFIK_DOMAIN="${{ vars.TRAEFIK_DOMAIN }}"
            export TRAEFIK_LOG_LEVEL="${{ vars.TRAEFIK_LOG_LEVEL }}"
            export ACME_EMAIL="${{ vars.ACME_EMAIL }}"
            export FRONTEND_DOMAIN="${{ vars.FRONTEND_DOMAIN }}"
            export FRONTEND_URL="${{ vars.FRONTEND_URL }}"
            export WEBSOCKET_CORS_ORIGINS="${{ vars.WEBSOCKET_CORS_ORIGINS }}"
            export LOG_LEVEL="${{ vars.LOG_LEVEL }}"
            export BUILD_ENV="${{ vars.BUILD_ENV }}"
            export RESTART_POLICY="${{ vars.RESTART_POLICY }}"
            export VOLUME_MODE="${{ vars.VOLUME_MODE }}"
            export GRAFANA_DOMAIN="${{ vars.GRAFANA_DOMAIN }}"
            export PROMETHEUS_DOMAIN="${{ vars.PROMETHEUS_DOMAIN }}"
            export TRAEFIK_HTTPS_ENABLED=true
            export HEALTHCHECK_INTERVAL=30s
            export HEALTHCHECK_TIMEOUT=10s
            export HEALTHCHECK_RETRIES=3
            export HEALTHCHECK_START_PERIOD=60s
            
            mkdir -p ~/ploscope

            # Check if the Docker network 'plo-network-cloud' exists, create if not
            if ! docker network inspect plo-network-cloud >/dev/null 2>&1; then
              echo "üîó Creating Docker network plo-network-cloud with subnet 172.30.1.0/24..."
              docker network create --subnet=172.30.1.0/24 plo-network-cloud
            else
              echo "üîó Docker network plo-network-cloud already exists."
            fi
            
            if [ ! -d "$HOME/ploscope/traefik/.git" ]; then
              echo "üì• Repository doesn't exist, cloning..."
              cd ~/ploscope
              git clone git@github.com:ploscope/traefik.git traefik
              cd traefik
              git checkout ${{ inputs.branch }}
            else
              echo "üìÇ Repository exists, pulling latest changes..."
              cd ~/ploscope/traefik
              git fetch origin
              git reset --hard origin/${{ inputs.branch }}
            fi

            docker compose -f docker-compose.yml up -d

            # Wait for the traefik container to become healthy before exiting
            echo "‚è≥ Waiting for traefik container to become healthy..."
            for i in {1..30}; do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' traefik-${ENVIRONMENT} 2>/dev/null || echo "notfound")
              if [ "$STATUS" = "healthy" ]; then
                echo "‚úÖ Traefik container is healthy."
                break
              elif [ "$STATUS" = "unhealthy" ]; then
                echo "‚ùå Traefik container is unhealthy."
                exit 1
              elif [ "$STATUS" = "notfound" ]; then
                echo "‚ö†Ô∏è  Traefik container not found. Waiting..."
              else
                echo "‚è≥ Waiting for health status... (current: $STATUS)"
              fi
              sleep 5
              if [ $i -eq 30 ]; then
                echo "‚ùå Timeout waiting for traefik container to become healthy."
                exit 1
              fi
            done