# Traefik Configuration Guide

This document explains the Traefik configuration setup for different deployment environments in PLOSolver.

## Overview

PLOSolver uses Traefik as a reverse proxy and load balancer. Due to different networking requirements between local development and Docker deployment, we maintain separate configuration files:

- **Local Development**: Uses generated `dynamic.yml` (localhost URLs)
- **Docker/Production Deployment**: Uses static `dynamic.docker.yml` (Docker service names)

## Configuration Files

### 1. `dynamic.yml` (Generated - Local Development)
- **Location**: Root directory (generated by `scripts/development/run_with_traefik.sh`)
- **Usage**: Local development with `make run`
- **Network**: Host network (localhost:5001, localhost:3000)
- **Status**: Git ignored (generated file)

### 2. `dynamic.docker.yml` (Static - Docker Deployment)
- **Location**: Root directory (version controlled)
- **Usage**: Docker deployment (`docker compose up`, staging, production)
- **Network**: Docker network (backend:5001, frontend:3000)
- **Status**: Version controlled

### 3. `docker compose.prod.yml` (Production Override)
- **Location**: Root directory
- **Usage**: Production-specific Docker Compose overrides
- **Purpose**: Additional production configurations

## Deployment Scenarios

### Local Development (`make run`)

```bash
# Uses run_with_traefik.sh which generates dynamic.yml
make run
```

**Configuration**:
- File: `dynamic.yml` (auto-generated)
- Backend URL: `http://localhost:5001`
- Frontend URL: `http://localhost:3000`
- Network: Host networking

### Docker Development

```bash
# Uses docker compose.yml with dynamic.docker.yml
make run-docker
```

**Configuration**:
- File: `dynamic.docker.yml` (static)
- Backend URL: `http://backend:5001`
- Frontend URL: `http://frontend:3000`
- Network: Docker bridge network

### Staging Deployment

```bash
# Uses staging environment with Docker service names
make staging-deploy
```

**Configuration**:
- File: `dynamic.docker.yml` (static)
- Domain: `ploscope.com`
- SSL: Enabled
- Network: Docker bridge network

### Production Deployment

```bash
# Uses production override file
docker compose -f docker-compose.yml -f docker compose.prod.yml up -d
```

**Configuration**:
- File: `dynamic.docker.yml` (static)
- Additional overrides from `docker compose.prod.yml`
- SSL: Required
- Network: Docker bridge network

## Route Configuration

All configurations include these routes (with different service URLs):

### API Routes
- **Auth**: `/api/auth/*` → Backend (with prefix stripping)
- **General API**: `/api/*` → Backend (with prefix stripping)
- **Priority**: Auth (3), General API (2), Frontend (1)

### Frontend Routes
- **Root**: `/*` → Frontend
- **Priority**: 1 (lowest, catch-all)

### Middleware
- **CORS**: Enabled for all routes
- **Strip Prefix**: `/api` prefix removed for backend routes
- **Headers**: All necessary CORS headers configured

## Troubleshooting

### 405 Method Not Allowed
- **Cause**: Service URL mismatch (localhost vs Docker service names)
- **Solution**: Ensure correct configuration file is being used
- **Check**: Verify `docker compose.yml` references `dynamic.docker.yml`

### Service Unreachable
- **Local Dev**: Check if services are running on localhost:5001/3000
- **Docker**: Check if services are running in Docker network
- **Debug**: Use `docker compose logs traefik` to see routing logs

### Configuration Not Loading
- **Check**: Traefik volume mounts in `docker compose.yml`
- **Verify**: File exists and has correct format
- **Debug**: Enable Traefik debug logging in `traefik.yml`

## File Structure

```
PLOSolver/
├── server/traefik/
│   ├── dynamic.docker.yml   # Static - Docker deployment  
│   └── traefik.yml         # Traefik main configuration
├── dynamic.yml              # Generated (gitignored) - Local dev
├── docker compose.yml       # Main compose file
└── docker compose.prod.yml  # Production overrides
└── scripts/
    └── run_with_traefik.sh # Generates dynamic.yml for local dev
```

## Environment Variables

### Key Variables
- `FRONTEND_DOMAIN`: Domain for frontend routing (default: localhost)
- `TRAEFIK_DOMAIN`: Domain for Traefik configuration
- `TRAEFIK_HTTPS_ENABLED`: Enable HTTPS/TLS (production)

### Usage Examples
```bash
# Staging
FRONTEND_DOMAIN=ploscope.com make staging-deploy

# Local with custom domain
FRONTEND_DOMAIN=local.plosolver.com make run
```

## Testing Configuration

### Verify Routes
```bash
# Test API endpoint
curl -X POST https://ploscope.com/api/simulated-equity

# Test health check
curl https://ploscope.com/api/health

# Test frontend
curl https://ploscope.com/
```

### Debug Traefik
```bash
# View Traefik dashboard
open http://localhost:8080  # or https://ploscope.com:8080

# Check container logs
docker compose logs traefik

# Debug routing
make debug-traefik
```

## Migration Notes

### From Single Configuration
The previous setup used a single `dynamic.yml` file for both local and Docker deployment, causing 405 Method Not Allowed errors in Docker because:

1. Traefik in Docker tried to reach `localhost:5001`
2. But `localhost` inside Docker container ≠ host machine
3. Services are accessible via Docker service names (`backend:5001`)

### Solution Benefits
1. **Separation of Concerns**: Different configs for different environments
2. **No Conflicts**: Local development doesn't break Docker deployment
3. **Maintainable**: Clear configuration per environment
4. **Debuggable**: Easier to troubleshoot environment-specific issues 