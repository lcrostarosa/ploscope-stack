name: Dependency Updates

on:
  schedule:
    # Run dependency updates weekly on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of dependencies to update'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - frontend
          - backend
          - security-only

env:
  REGISTRY: docker.io
  IMAGE_NAME: ploscope

jobs:
  dependency-updates:
    name: Dependency Updates
    runs-on: ${{ vars.GHA_RUNNER }}
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Backend dependency updates
      - name: Backend dependency updates
        if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'backend' || github.event.inputs.update_type == 'security-only'
        run: |
          echo "ðŸ“¦ Updating backend dependencies..."
          cd src/backend

          # Configure Poetry
          poetry config virtualenvs.in-project true

          # Install current dependencies
          poetry install

          if [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "ðŸ”’ Running security-only updates..."
            poetry run safety check --fix || true
          else
            echo "ðŸ”„ Running full dependency updates..."
            # Update dependencies
            poetry update

            # Update security vulnerabilities
            poetry run safety check --fix || true
          fi

          # Reinstall and test
          poetry install
          poetry run make test || echo "Tests failed, but continuing..."

          echo "âœ… Backend dependencies updated"

      # Create Pull Request for backend updates
      - name: Create Pull Request for backend updates
        if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'backend' || github.event.inputs.update_type == 'security-only'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update backend dependencies [skip ci]'
          title: 'chore: update backend dependencies [skip ci]'
          body: |
            Automated dependency updates for backend packages.

            This PR includes:
            - Non-breaking dependency updates
            - Security fixes from safety check

            Please review the changes and test thoroughly before merging.
          branch: chore/update-backend-deps
          delete-branch: true
          path: src/backend

      # Summary
      - name: Create update summary
        if: always()
        run: |
          echo "## Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update Type:** ${{ github.event.inputs.update_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.update_type }}" = "all" ] || [ "${{ github.event.inputs.update_type }}" = "frontend" ] || [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "### Frontend Updates" >> $GITHUB_STEP_SUMMARY
            if [ -f "src/frontend/outdated.json" ]; then
              echo "ðŸ“¦ **Outdated packages checked**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "âœ… **Frontend dependencies processed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.event.inputs.update_type }}" = "all" ] || [ "${{ github.event.inputs.update_type }}" = "backend" ] || [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "### Backend Updates" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Backend dependencies processed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated pull requests" >> $GITHUB_STEP_SUMMARY
          echo "2. Run tests to ensure compatibility" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge updates after thorough testing" >> $GITHUB_STEP_SUMMARY
