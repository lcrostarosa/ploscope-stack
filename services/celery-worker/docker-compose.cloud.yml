# Celery Worker Staging Docker Compose Configuration
# This file contains only the celeryworker service for staging deployment

services:
  celeryworker:
    image: ploscope/celery-worker:${IMAGE_TAG:-staging}
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      secrets:
        - nexus_username
        - nexus_password
      args:
        BUILD_ENV: production
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://nexus.ploscope.com/repository/pypi-internal/simple/}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-nexus.ploscope.com}
        BUILDKIT_INLINE_CACHE: 1
    container_name: celeryworker-${ENVIRONMENT}
    environment:
      # Application Environment
      - APP_NAME=celery-worker
      - ENVIRONMENT=${ENVIRONMENT}
      - REF_NAME=${REF_NAME}
      - REF_TYPE=${REF_TYPE}

      # Database Configuration
      - DATABASE_URL=${DATABASE_URL}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

      # Celery Configuration
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - CELERY_ENABLE_UTC=${CELERY_ENABLE_UTC}
      - CELERY_HEALTH_PORT=${CELERY_HEALTH_PORT}
      - CELERY_RESULT_SERIALIZER=${CELERY_RESULT_SERIALIZER}
      - CELERY_TASK_SERIALIZER=${CELERY_TASK_SERIALIZER}
      - CELERY_TASK_SOFT_TIME_LIMIT=${CELERY_TASK_SOFT_TIME_LIMIT}
      - CELERY_TASK_TIME_LIMIT=${CELERY_TASK_TIME_LIMIT}
      - CELERY_TASK_TRACK_STARTED=${CELERY_TASK_TRACK_STARTED}
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY}
      - CELERY_CONCURRENCY=${CELERY_WORKER_CONCURRENCY}
      - CELERY_WORKER_MAX_TASKS_PER_CHILD=${CELERY_WORKER_MAX_TASKS_PER_CHILD}

      # RabbitMQ Configuration
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST}

      # RabbitMQ Queue Configuration
      - RABBITMQ_SPOT_QUEUE=${RABBITMQ_SPOT_QUEUE}
      - RABBITMQ_SOLVER_QUEUE=${RABBITMQ_SOLVER_QUEUE}
      - RABBITMQ_SPOT_DLQ=${RABBITMQ_SPOT_DLQ}
      - RABBITMQ_SOLVER_DLQ=${RABBITMQ_SOLVER_DLQ}
      - RABBITMQ_MAIN_EXCHANGE=plosolver.main
      - RABBITMQ_DLQ_EXCHANGE=plosolver.dlq

      # Security
      - SECRET_KEY=${SECRET_KEY}

      # Nexus Repository Configuration
      - PIP_INDEX_URL=${PIP_INDEX_URL}
      - PIP_TRUSTED_HOST=${PIP_TRUSTED_HOST}
      - NEXUS_PYPI_PASSWORD=${NEXUS_PYPI_PASSWORD}
      - NEXUS_PYPI_USERNAME=${NEXUS_PYPI_USERNAME}

      # Application Path
      - APP_PATH=${APP_PATH}

      # Redis Configuration
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_DB=${REDIS_DB}
      - REDIS_URL=${REDIS_URL}

    healthcheck:
      test: [ "CMD", "python", "/app/health_check.py" ]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      plo-network-cloud:
        ipv4_address: 172.30.1.24
    volumes:
      - shared-logs:/app/logs

secrets:
  nexus_username:
    environment: NEXUS_PYPI_USERNAME
  nexus_password:
    environment: NEXUS_PYPI_PASSWORD

volumes:
  shared-logs:

networks:
  plo-network-cloud:
    external: true
