name: Dependency Updates

on:
  schedule:
    # Run dependency updates weekly on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of dependencies to update'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - frontend
          - backend
          - security-only

env:
  REGISTRY: docker.io
  IMAGE_NAME: ploscope

jobs:
  dependency-updates:
    name: Dependency Updates
    runs-on: ${{ vars.GHA_RUNNER }}
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            src/backend/requirements.txt
            src/backend/requirements-dev.txt

      - name: Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: |
            src/frontend/node_modules
            ~/.npm
            src/frontend/outdated.json
          key: ${{ runner.os }}-dep-node-${{ hashFiles('src/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-dep-node-

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            src/backend/.venv
            ~/.cache/pip
            ~/.cache/pip-tools
          key: ${{ runner.os }}-dep-pip-${{ hashFiles('src/backend/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-dep-pip-

      # Frontend dependency updates
      - name: Frontend dependency updates
        if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'frontend' || github.event.inputs.update_type == 'security-only'
        run: |
          echo "ðŸ“¦ Updating frontend dependencies..."
          cd src/frontend

          # Install current dependencies
          npm ci

          # Check for outdated packages
          npm outdated --json > outdated.json || true
          echo "Current outdated packages:"
          cat outdated.json

          if [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "ðŸ”’ Running security-only updates..."
            npm audit fix --audit-level=moderate || true
          else
            echo "ðŸ”„ Running full dependency updates..."
            npm update
            npm audit fix --audit-level=moderate || true
          fi

          # Reinstall and test
          npm ci
          npm test -- --watchAll=false || echo "Tests failed, but continuing..."

          echo "âœ… Frontend dependencies updated"

      # Backend dependency updates
      - name: Backend dependency updates
        if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'backend' || github.event.inputs.update_type == 'security-only'
        run: |
          echo "ðŸ“¦ Updating backend dependencies..."
          cd src/backend

          # Install current dependencies
          pip install -r requirements.txt

          if [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "ðŸ”’ Running security-only updates..."
            pip-audit --fix || true
          else
            echo "ðŸ”„ Running full dependency updates..."
            # Update pip-tools if available
            if [ -f "requirements.in" ]; then
              pip-compile --upgrade requirements.in
            fi

            # Update security vulnerabilities
            pip-audit --fix || true
          fi

          # Reinstall and test
          pip install -r requirements.txt
          make test || echo "Tests failed, but continuing..."

          echo "âœ… Backend dependencies updated"

      # Create Pull Request for updates
      - name: Create Pull Request for frontend updates
        if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'frontend' || github.event.inputs.update_type == 'security-only'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update frontend dependencies [skip ci]'
          title: 'chore: update frontend dependencies [skip ci]'
          body: |
            Automated dependency updates for frontend packages.

            This PR includes:
            - Non-breaking dependency updates
            - Security fixes from npm audit

            Please review the changes and test thoroughly before merging.
          branch: chore/update-frontend-deps
          delete-branch: true
          path: src/frontend

      # Create Pull Request for backend updates
      - name: Create Pull Request for backend updates
        if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'backend' || github.event.inputs.update_type == 'security-only'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update backend dependencies [skip ci]'
          title: 'chore: update backend dependencies [skip ci]'
          body: |
            Automated dependency updates for backend packages.

            This PR includes:
            - Non-breaking dependency updates
            - Security fixes from pip-audit

            Please review the changes and test thoroughly before merging.
          branch: chore/update-backend-deps
          delete-branch: true
          path: src/backend

      # Summary
      - name: Create update summary
        if: always()
        run: |
          echo "## Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update Type:** ${{ github.event.inputs.update_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.update_type }}" = "all" ] || [ "${{ github.event.inputs.update_type }}" = "frontend" ] || [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "### Frontend Updates" >> $GITHUB_STEP_SUMMARY
            if [ -f "src/frontend/outdated.json" ]; then
              echo "ðŸ“¦ **Outdated packages checked**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "âœ… **Frontend dependencies processed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.event.inputs.update_type }}" = "all" ] || [ "${{ github.event.inputs.update_type }}" = "backend" ] || [ "${{ github.event.inputs.update_type }}" = "security-only" ]; then
            echo "### Backend Updates" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Backend dependencies processed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated pull requests" >> $GITHUB_STEP_SUMMARY
          echo "2. Run tests to ensure compatibility" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge updates after thorough testing" >> $GITHUB_STEP_SUMMARY
