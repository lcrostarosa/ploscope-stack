name: PR Staging Deploy

on:
  pull_request:
    types: [labeled, opened, synchronize, reopened]
    branches:
      - master
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to deploy"
        required: false
      image_tag:
        description: "Override image tag (defaults to PR-<number>)"
        required: false

jobs:
  deploy-staging:
    if: >-
      ${{ github.event_name == 'workflow_dispatch' ||
          contains(github.event.pull_request.labels.*.name, 'deploy-staging') }}
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine PR number and image tag
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.pr_number }}" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          TAG_INPUT="${{ github.event.inputs.image_tag }}"
          if [ -n "$TAG_INPUT" ]; then
            IMAGE_TAG="$TAG_INPUT"
          else
            IMAGE_TAG="PR-${PR_NUMBER}"
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Create variables file from secrets
        run: |
          mkdir -p variables
          cat > variables/vars.yml <<'VARS'
          git_repo_url: "${{ secrets.GIT_REPO_URL }}"
          git_branch: "${{ github.head_ref || format('refs/pull/{0}/merge', steps.pr.outputs.pr_number) }}"
          project_dir: "${{ secrets.PROJECT_DIR }}"
          ssl_dir: "${{ secrets.SSL_DIR }}"
          hetzner_server_ip: "${{ secrets.HETZNER_SERVER_IP }}"
          hetzner_private_key_file: "~/.ssh/deploy_key"
          hetzner_public_key_file: "~/.ssh/deploy_key.pub"
          domain: "${{ vars.DOMAIN }}"
          appuser_password: "${{ secrets.APPUSER_PASSWORD }}"
          github_token: "${{ secrets.GH_TOKEN }}"
          github_username: "${{ vars.GH_USERNAME }}"
          gha_runner_token: "${{ secrets.GHA_RUNNER_TOKEN }}"
          docker_username: "${{ secrets.DOCKER_USERNAME }}"
          docker_password: "${{ secrets.DOCKER_PASSWORD }}"
          image_tag: "${{ steps.pr.outputs.image_tag }}"
          VARS

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HETZNER_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Ansible deploy to staging
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook -i inventories/inventory.yml 02_deploy.yml -e @variables/vars.yml