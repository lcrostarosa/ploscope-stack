name: Deploy Nexus Repository

on:
  workflow_dispatch:

env:
  REGISTRY: docker.io
  NAMESPACE: ploscope
  IMAGE_NAME: nexus

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  deploy:
    name: Deploy Nexus
    runs-on: ${{ vars.GHA_RUNNER }}
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment: nexus
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

           
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
    
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          allenvs: true
          script: |
            set -e
            echo "üöÄ Deploying Nexus..."
            
            # Create project directory if it doesn't exist
            mkdir -p ~/ploscope

            # Check if the Docker network 'plo-network-cloud' exists, create if not
            if ! docker network inspect plo-network-cloud >/dev/null 2>&1; then
              echo "üîó Creating Docker network plo-network-cloud with subnet 172.30.1.0/24..."
              docker network create --subnet=172.30.1.0/24 plo-network-cloud
            else
              echo "üîó Docker network plo-network-cloud already exists."
            fi
            
            # Check if repository exists, clone if it doesn't
            if [ ! -d "$HOME/ploscope/nexus/.git" ]; then
              echo "üì• Repository doesn't exist, cloning..."
              cd ~/ploscope
              git clone git@github.com:ploscope/nexus.git nexus
              cd nexus
              git checkout master
            else
              echo "üìÇ Repository exists, pulling latest changes..."
              cd ~/ploscope/nexus
              git fetch origin
              git reset --hard origin/master
            fi
            
            docker compose -f docker-compose-nexus.yml up -d

            # Wait for the nexus container to become healthy before exiting
            echo "‚è≥ Waiting for nexus container to become healthy..."
            for i in {1..30}; do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' nexus 2>/dev/null || echo "notfound")
              if [ "$STATUS" = "healthy" ]; then
                echo "‚úÖ nexus container is healthy."
                break
              elif [ "$STATUS" = "unhealthy" ]; then
                echo "‚ùå nexus container is unhealthy."
                exit 1
              elif [ "$STATUS" = "notfound" ]; then
                echo "‚ö†Ô∏è  nexus container not found. Waiting..."
              else
                echo "‚è≥ Waiting for health status... (current: $STATUS)"
              fi
              sleep 5
              if [ $i -eq 30 ]; then
                echo "‚ùå Timeout waiting for nexus container to become healthy."
                exit 1
              fi
            done


            ./setup-nexus.sh