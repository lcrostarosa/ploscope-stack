# PLOScope Production Overrides
# Optimized for production deployment
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Features:
#   - HTTPS via Traefik with Let's Encrypt
#   - Resource limits
#   - Optimized logging
#   - Health checks with tighter intervals

services:
  # ============================================
  # INFRASTRUCTURE - Production Settings
  # ============================================

  traefik:
    command:
      - --api.dashboard=true
      - --api.insecure=false
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=plo-network-cloud
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/certs/acme.json
      - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
      - --log.level=WARN
      - --accesslog=true
      - --accesslog.filepath=/var/log/traefik/access.log
      - --accesslog.bufferingsize=100
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  redis:
    command: >
      redis-server 
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy volatile-lru
      --appendonly yes
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  rabbitmq:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  db:
    image: postgres:15
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c work_mem=8MB
      -c maintenance_work_mem=128MB
      -c effective_cache_size=768MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c random_page_cost=1.1
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # CORE SERVICES - Production Settings
  # ============================================

  backend:
    labels:
      traefik.enable: "true"
      traefik.http.routers.backend.rule: "Host(`api.${DOMAIN}`) || (Host(`${DOMAIN}`) && PathPrefix(`/api`))"
      traefik.http.routers.backend.entrypoints: "websecure"
      traefik.http.routers.backend.tls.certresolver: "letsencrypt"
      traefik.http.services.backend.loadbalancer.server.port: "5001"
    environment:
      - FLASK_DEBUG=false
      - FLASK_ENV=production
      - LOG_LEVEL=WARNING
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      replicas: 2

  backend-grpc:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  frontend:
    labels:
      traefik.enable: "true"
      traefik.http.routers.frontend.rule: "Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      traefik.http.routers.frontend.entrypoints: "websecure"
      traefik.http.routers.frontend.tls.certresolver: "letsencrypt"
      traefik.http.routers.frontend.priority: "1"
      traefik.http.services.frontend.loadbalancer.server.port: "3000"
      # Redirect www to non-www
      traefik.http.middlewares.www-redirect.redirectregex.regex: "^https://www\\.(.+)"
      traefik.http.middlewares.www-redirect.redirectregex.replacement: "https://$${1}"
      traefik.http.routers.frontend.middlewares: "www-redirect"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ============================================
  # WORKERS - Production Settings
  # ============================================

  celery-worker:
    environment:
      - LOG_LEVEL=INFO
      - CELERY_WORKER_CONCURRENCY=8
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      replicas: 2

  # ============================================
  # MONITORING - Production Settings
  # ============================================

  prometheus:
    profiles: []  # Enable in production
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  grafana:
    profiles: []  # Enable in production
    labels:
      traefik.enable: "true"
      traefik.http.routers.grafana.rule: "Host(`grafana.${DOMAIN}`)"
      traefik.http.routers.grafana.entrypoints: "websecure"
      traefik.http.routers.grafana.tls.certresolver: "letsencrypt"
      traefik.http.services.grafana.loadbalancer.server.port: "3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_LOG_LEVEL=warn
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  loki:
    profiles: []  # Enable in production
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M
